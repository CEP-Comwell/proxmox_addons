# Tenant-Specific NFTables Rules Template
# Generated by Ansible for tenant: {{ tenant_id }}
# Bridge: {{ bridge_name }}

# Tenant {{ tenant_id }} bridge filtering for {{ bridge_name }}
table bridge {{ bridge_name }}_tenant_{{ tenant_id }} {
    # INGRESS rules for tenant {{ tenant_id }}
    chain tenant_{{ tenant_id }}_input {
        type filter hook input priority -150;

        # Tenant-specific ingress rules
        iif "{{ bridge_name }}" ip saddr {{ tenant_network }} {{ tenant_ingress_rules | default('accept') }}

        {% if tenant_ports %}
        # Allow specific ports for tenant {{ tenant_id }}
        iif "{{ bridge_name }}" tcp dport { {{ tenant_ports | join(', ') }} } accept;
        {% endif %}
    }

    # EGRESS rules for tenant {{ tenant_id }}
    chain tenant_{{ tenant_id }}_forward {
        type filter hook forward priority -150;

        # Tenant-specific egress rules
        iif "{{ bridge_name }}" oif {{ tenant_egress_interfaces | default('"vmbr1", "vmbr2"') }} ip daddr {{ tenant_network }} {{ tenant_egress_rules | default('accept') }}

        {% if tenant_isolation %}
        # Isolation rules - prevent communication with other tenants
        iif "{{ bridge_name }}" oif {{ tenant_egress_interfaces | default('"vmbr1", "vmbr2"') }} ip daddr != {{ tenant_network }} drop;
        {% endif %}
    }
}

# Tenant {{ tenant_id }} IP filtering for {{ bridge_name }}
table ip {{ bridge_name }}_tenant_{{ tenant_id }}_ip {
    # INGRESS IP rules
    chain tenant_{{ tenant_id }}_input {
        type filter hook input priority -150;

        # Rate limiting for tenant {{ tenant_id }}
        {% if tenant_rate_limit %}
        iif "{{ bridge_name }}" ip saddr {{ tenant_network }} limit rate {{ tenant_rate_limit }} accept;
        iif "{{ bridge_name }}" ip saddr {{ tenant_network }} drop;
        {% endif %}
    }

    # EGRESS IP rules
    chain tenant_{{ tenant_id }}_forward {
        type filter hook forward priority -150;

        # QoS marking for tenant {{ tenant_id }}
        {% if tenant_dscp %}
        iif "{{ bridge_name }}" ip saddr {{ tenant_network }} ip dscp set {{ tenant_dscp }};
        {% endif %}
    }
}