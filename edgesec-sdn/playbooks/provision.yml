# Playbook: provision.yml
# Description: Provisions each Proxmox node (networks, bridges, base services + NIC naming)
# Usage: ansible-playbook -i ../../inventory provision.yml

- name: Provision Proxmox node
  hosts: proxmox-hosts
  become: true
  gather_facts: false
  vars:
    # Optional overrides; set these with -e when running if you want to control behavior
    # safety defaults for network provisioning (override with -e)
    # - write_interfaces_file: when true, the role will write /etc/network/interfaces.d/*.cfg files
    # - ovs_create: when true, the role will run ovs-vsctl live commands to create OVS runtime state
    # - force_ovsclean: when true, the role will perform destructive normalization/cleanup of OVS blocks
    write_interfaces_file: false
    ovs_create: false
    force_ovsclean: false
    # provision_confirm_before_apply: false
  roles:
    - prereqs           # Install prerequisite packages (jq, git, etc.)
    - network_provision  # Streamlined role for interface naming and Linux bridge creation
    - ovs_bridge_provision # New role: render and persist OVS bridge stanzas into /etc/network/interfaces
    - ovs_vxlan_provision  # Create OVS VXLAN ports (ovs-vsctl driven)
    #- vxlan              # Create and configure VXLAN overlays on node(s)
    #- sdn_fabric_provision  # Provisions SDN fabric, VNETs, subnets, ports (never touches vmbr0)
  # Handlers are provided by roles (for example network_provision provides
  # a guarded `reload_network` handler). Do not define a play-level
  # reload handler here so the role's guarded handler is used.