---
# Playbook: backup_network.yml
# Description: Captures the current Proxmox bridge/interface configuration for
# each host in the inventory and writes a timestamped JSON backup locally.
# Usage: ansible-playbook -i ../../inventory backup_network.yml

- name: Backup Proxmox network interface configuration
  hosts: proxmox-hosts
  become: true
  gather_facts: true
  vars:
    backup_dir: "{{ playbook_dir }}/../../backups/network/{{ inventory_hostname }}"
    proxmox_node_name: "{{ hostvars[inventory_hostname].get('proxmox_node_name', inventory_hostname_short) }}"
  tasks:
    - name: Ensure local backup directory exists
      delegate_to: localhost
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: "0750"

    - name: Fetch current Proxmox network configuration
      command: >-
        pvesh get /nodes/{{ proxmox_node_name }}/network --output-format json
      register: proxmox_network_config
      changed_when: false

    - name: Write network configuration backup locally
      delegate_to: localhost
      copy:
        dest: "{{ backup_dir }}/network-{{ ansible_date_time.iso8601 | regex_replace(':', '') }}.json"
        content: "{{ proxmox_network_config.stdout }}\n"
        mode: "0640"

    - name: Display backup file path
      delegate_to: localhost
      debug:
        msg: "Saved Proxmox network backup for {{ inventory_hostname }} to {{ backup_dir }}"
