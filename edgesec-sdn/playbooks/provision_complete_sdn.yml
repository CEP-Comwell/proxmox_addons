---
# Complete SDN Provisioning with NFTables
# Orchestrates network_provision â†’ vxlan â†’ nftables roles
# Provides full SDN infrastructure setup with bridge access control

- name: "Complete SDN Infrastructure Provisioning"
  hosts: proxmox-hosts
  become: true

  pre_tasks:
    - name: Display provisioning start
      ansible.builtin.debug:
        msg: "ğŸš€ Starting Complete SDN Provisioning (network_provision â†’ vxlan â†’ nftables)"

  roles:
    - network_provision    # Phase 1: Network interface discovery, pinning, and bridging
    - vxlan               # Phase 2: SDN components (controllers, zones, vnets)
    - nftables            # Phase 3: Bridge access control and firewall rules

  post_tasks:
    - name: Display completion summary
      ansible.builtin.debug:
        msg: |
          âœ… Complete SDN Provisioning finished successfully!

          ğŸ“‹ What was configured:
          ğŸ”— Network interfaces discovered and pinned
          ğŸŒ‰ SDN bridges created (vmbr99, vmbr1, vmbr2)
          ğŸ›ï¸  SDN controllers, zones, and VNets established
          ğŸ”’ NFTables firewall & NAT rules applied

          ğŸ§ª Test the setup:
          - VNets on vmbr1, vmbr2, and vmbr99 reach the internet via vmbr0
          - Bridges can talk to each other (ping between vmbr1 â†” vmbr2)
          - Validate masquerading: curl https://example.com from each segment

          ğŸ“– See roles documentation for details:
          - network_provision: Interface management
          - vxlan: SDN infrastructure
          - nftables: Bridge access control