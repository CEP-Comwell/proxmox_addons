# Ansible Variables for SDN Bridge Access Control
# This implements: Management can access all, but tenant/gateway bridges are isolated

# Bridge Access Control Variables
bridge_access_control:
  vmbr99:
    # Management Bridge - Full Access
    ingress_policy: "allow_from_all_responses"
    egress_policy: "allow_to_all"
    allowed_peers: ["vmbr1", "vmbr2"]
    blocked_peers: []

  vmbr1:
    # Tenant Bridge - Management Only
    ingress_policy: "management_only"
    egress_policy: "management_only"
    allowed_peers: ["vmbr99"]
    blocked_peers: ["vmbr2"]

  vmbr2:
    # Gateway Bridge - Management Only
    ingress_policy: "management_only"
    egress_policy: "management_only"
    allowed_peers: ["vmbr99"]
    blocked_peers: ["vmbr1"]

# Detailed Rule Sets
nftables_rules:
  vmbr99:
    ingress:
      - "iif \"vmbr99\" arp accept"
      - "iif \"vmbr99\" udp dport 67 udp sport 68 accept"
      - "iif \"vmbr99\" ct state established,related accept"
      - "iif \"vmbr99\" icmp type echo-reply accept"
      - "iif \"vmbr99\" ct state invalid drop"
    egress:
      - "iif \"vmbr99\" oif \"vmbr1\" accept"
      - "iif \"vmbr99\" oif \"vmbr2\" accept"
      - "ct state established,related accept"

  vmbr1:
    ingress:
      - "iif \"vmbr1\" iif != \"vmbr99\" drop"
      - "iif \"vmbr1\" arp accept"
      - "iif \"vmbr1\" udp dport 67 udp sport 68 accept"
      - "iif \"vmbr1\" icmp type echo-request accept"
      - "iif \"vmbr1\" ct state established,related accept"
    egress:
      - "iif \"vmbr1\" oif \"vmbr99\" accept"
      - "iif \"vmbr1\" oif \"vmbr2\" drop"
      - "iif \"vmbr1\" oif \"vmbr99\" icmp type echo-reply accept"

  vmbr2:
    ingress:
      - "iif \"vmbr2\" iif != \"vmbr99\" drop"
      - "iif \"vmbr2\" arp accept"
      - "iif \"vmbr2\" udp dport 67 udp sport 68 accept"
      - "iif \"vmbr2\" icmp type echo-request accept"
      - "iif \"vmbr2\" ct state established,related accept"
    egress:
      - "iif \"vmbr2\" oif \"vmbr99\" accept"
      - "iif \"vmbr2\" oif \"vmbr1\" drop"
      - "iif \"vmbr2\" oif \"vmbr99\" icmp type echo-reply accept"

# Ping Test Matrix (what should work)
ping_matrix:
  from_vmbr99_to_vmbr1: "ALLOWED (management → tenant)"
  from_vmbr99_to_vmbr2: "ALLOWED (management → gateway)"
  from_vmbr1_to_vmbr99: "ALLOWED (responses only)"
  from_vmbr2_to_vmbr99: "ALLOWED (responses only)"
  from_vmbr1_to_vmbr2: "BLOCKED (tenant isolation)"
  from_vmbr2_to_vmbr1: "BLOCKED (gateway isolation)"

# Usage Example:
# ansible-playbook playbooks/nftables_bridge_rules.yml \
#   -e @examples/bridge_access_control_vars.yml