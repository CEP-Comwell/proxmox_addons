---
- name: Apply firewalld baseline
  hosts: all
  become: true
  vars:
    allowed_services:
      - ssh
    allowed_rich_rules:
      - rule icmp-type name="echo-request" accept
    firewalld_masquerade_enabled: true
    firewalld_masquerade_zone: ztna_drop
  tasks:
    - name: Uninstall UFW
      apt:
        name: ufw
        state: absent
      when: ansible_os_family == "Debian"

    - name: Install firewalld (Debian)
      apt:
        name: firewalld
        state: present
      when: ansible_os_family == "Debian"

    - name: Install firewalld (RedHat/CentOS)
      yum:
        name: firewalld
        state: present
      when: ansible_os_family == "RedHat"

    - name: Ensure firewalld is running and enabled
      service:
        name: firewalld
        state: started
        enabled: yes

    - name: Check if ztna_drop zone exists
      command: firewall-cmd --get-zones
      register: firewalld_zones
      failed_when: false
      changed_when: false

    - name: Create ztna_drop zone
      firewalld:
        zone: ztna_drop
        state: present
        permanent: yes
      when: "'ztna_drop' not in firewalld_zones.stdout"

    - name: Refresh firewalld zone cache
      command: firewall-cmd --get-zones
      register: firewalld_zones
      changed_when: false

    - name: Reload firewalld after creating ztna_drop zone
      command: firewall-cmd --reload
      when: "'ztna_drop' not in firewalld_zones.stdout"

    - name: Get current default firewalld zone
      command: firewall-cmd --get-default-zone
      register: firewalld_default_zone
      changed_when: false

    - name: Set default zone to ztna_drop
      command: firewall-cmd --set-default-zone=ztna_drop
      when: firewalld_default_zone.stdout.strip() != 'ztna_drop'

    - name: Allow specified services in ztna_drop zone
      firewalld:
        service: "{{ item }}"
        zone: ztna_drop
        state: enabled
        permanent: yes
      loop: "{{ allowed_services }}"

    - name: Allow specified rich rules in ztna_drop zone
      firewalld:
        rich_rule: "{{ item }}"
        zone: ztna_drop
        state: enabled
        permanent: yes
      loop: "{{ allowed_rich_rules }}"

    - name: Set default target to DROP in ztna_drop zone
      firewalld:
        zone: ztna_drop
        target: DROP
        state: enabled
        permanent: yes

    - name: Ensure masquerade is enabled in desired zone
      firewalld:
        zone: "{{ firewalld_masquerade_zone }}"
        masquerade: yes
        state: enabled
        permanent: yes
        immediate: yes
      when: firewalld_masquerade_enabled

    - name: Get list of all services in ztna_drop zone
      command: firewall-cmd --zone=ztna_drop --list-services
      register: ztna_drop_services
      when: "'ztna_drop' in firewalld_zones.stdout"
      changed_when: false

    - name: Remove all other services from ztna_drop zone
      firewalld:
        zone: ztna_drop
        service: "{{ item }}"
        state: disabled
        permanent: yes
      loop: "{{ ztna_drop_services.stdout.split() | difference(allowed_services) }}"
      when: "'ztna_drop' in firewalld_zones.stdout"

    - name: Restart firewalld
      service:
        name: firewalld
        state: restarted

    - name: Install Fail2Ban
      package:
        name: fail2ban
        state: present

    - name: Ensure /etc/fail2ban directory exists
      file:
        path: /etc/fail2ban
        state: directory
        mode: '0755'

    - name: Check if Fail2Ban jail.local exists
      stat:
        path: /etc/fail2ban/jail.local
      register: jail_local_stat

    - name: Read current Fail2Ban configuration if it exists
      command: cat /etc/fail2ban/jail.local
      register: current_fail2ban_config
      changed_when: false
      when: jail_local_stat.stat.exists

    - name: Configure Fail2Ban jail for SSH
      copy:
        dest: /etc/fail2ban/jail.local
        content: |
          [sshd]
          enabled = true
          port = ssh
          filter = sshd
          logpath = /var/log/auth.log
          maxretry = 3
          bantime = 900
      when: jail_local_stat.stat.exists == false or
            current_fail2ban_config.stdout != "[sshd]\nenabled = true\nport = ssh\nfilter = sshd\nlogpath = /var/log/auth.log\nmaxretry = 3\nbantime = 900"
      notify:
        - Restart Fail2Ban

    - name: Ensure Fail2Ban is running and enabled
      service:
        name: fail2ban
        state: started
        enabled: yes
      retries: 3
      delay: 5

  handlers:
    - name: Restart Fail2Ban
      service:
        name: fail2ban