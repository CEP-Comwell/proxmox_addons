---
# Deploy persistent OVS bridge block into /etc/network/interfaces

- name: Load host bridge definitions
  include_vars:
    file: "{{ playbook_dir }}/../../host_vars/{{ inventory_hostname }}/bridges.yml"
    name: host_bridges
  ignore_errors: true
  tags: [deploy_ovs_bridges]

- name: Compute OVS bridges (merge host + role, exclude vmbr2)
  set_fact:
    ovs_bridges: []

- name: "Collect OVS bridges from host/role defs (case-insensitive 'ovs' type)"
  set_fact:
    ovs_bridges: "{{ (ovs_bridges | default([])) + [ item ] }}"
  loop: "{{ (host_bridges.bridges | default([])) + (bridges | default([])) }}"
  loop_control:
    label: "{{ item.name | default('unnamed') }}"
  when: (item.type is defined) and (('ovs' in (item.type | lower))) and (item.name is defined) and (item.name != 'vmbr2')
  tags: [deploy_ovs_bridges]

- name: Build OVS /etc/network/interfaces block
  set_fact:
    ovs_bridge_block: "{{ lookup('template', playbook_dir + '/../../roles/ovs_bridge_provision/templates/ovs_bridges.j2') }}"
  when: ovs_bridges | length > 0
  changed_when: false
  tags: [deploy_ovs_bridges]
- name: Remove existing Linux bridge stanzas for OVS-named bridges
  become: true
  shell: |
    SRC=/etc/network/interfaces
    for br in {{ ovs_bridges | map(attribute='name') | join(' ') }}; do
      if grep -q "^auto ${br}\b" "$SRC"; then
        perl -0777 -i -pe "s/\nauto ${br}[\s\S]*?(?=\nauto |\n# BEGIN |\nsource )//g" "$SRC" || true
      fi
    done
  when: (ovs_bridges | length > 0) and (force_ovsclean | default(false))
  tags: [deploy_ovs_bridges]

- name: Normalize any existing OVS blocks and ensure spacing between iface stanzas
  include_tasks: normalize_ovs.yml
  tags: [deploy_ovs_bridges]


- name: "Fetch existing OVS block from target (if any)"
  become: true
  command: "sed -n '/# BEGIN OVS BRIDGES/,/# END OVS BRIDGES/p' /etc/network/interfaces"
  register: existing_ovs_block
  failed_when: false
  changed_when: false
  tags: [deploy_ovs_bridges]

- name: Insert OVS block into /etc/network/interfaces (above source include)
  become: true
  blockinfile:
    path: /etc/network/interfaces
    marker: "# {mark} OVS BRIDGES"
    block: "{{ ovs_bridge_block }}"
    insertbefore: '^source /etc/network/interfaces.d/*'
  when: (ovs_bridges | length > 0) and (write_interfaces_file | default(false)) and ((existing_ovs_block.stdout | default('') | trim) != (ovs_bridge_block | trim))
  tags: [deploy_ovs_bridges]

- name: Validate /etc/network/interfaces after OVS block
  become: true
  command: ifquery --list
  register: ifquery_after_ovs
  failed_when: ifquery_after_ovs.rc != 0
  changed_when: false
  when: (ovs_bridges | length > 0) and (write_interfaces_file | default(false))
  tags: [deploy_ovs_bridges]

- name: Reload network (ifquery passed)
  become: true
  command: ifreload -a
  when: (ovs_bridges | length > 0) and (write_interfaces_file | default(false)) and (perform_reload | default(false)) and (ifquery_after_ovs is defined and (ifquery_after_ovs.rc | default(1) == 0))
  tags: [deploy_ovs_bridges]

- name: Preview OVS block (no write)
  debug:
    msg: "{{ ovs_bridge_block }}"
  when: (ovs_bridges | length > 0) and not (write_interfaces_file | default(false))
  tags: [deploy_ovs_bridges]
