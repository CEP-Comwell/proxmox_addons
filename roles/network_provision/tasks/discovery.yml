---
# NEW: Interface discovery - consolidated from both old roles
# Gather all physical network interfaces except common virtual and bridge types
- name: Get list of physical interfaces
  shell: |
    ls -1 /sys/class/net | grep -vE '^(lo|vmbr|tap|fw|bonding_masters|veth|br|docker|virbr|wg|tun|bond|bridge)'
  register: interfaces_raw
  changed_when: false
  check_mode: no

# Store interface list for later use
- name: Set interface list
  set_fact:
    interfaces: "{{ interfaces_raw.stdout_lines }}"

- name: Preserve full interface list for discovery steps
  set_fact:
    all_interfaces: "{{ interfaces_raw.stdout_lines }}"

# Detect interface currently enslaved to vmbr0 (protect Proxmox management NIC)
- name: Detect interface currently enslaved to vmbr0 (protect Proxmox management NIC)
  shell: |
    for f in /sys/class/net/*; do
      if [ -e "$f/master" ]; then
        master=$(readlink -f "$f/master" 2>/dev/null || true)
        if [ "$(basename "$master")" = "vmbr0" ]; then
          basename "$f"
          exit 0
        fi
      fi
    done
  register: protected_mgmt_iface_raw
  changed_when: false
  check_mode: no

- name: Set protected management interface fact
  set_fact:
    protected_mgmt_iface: "{{ protected_mgmt_iface_raw.stdout | default('') }}"

# When Proxmox firewall creates a virtual front-end (fwpr*), fall back to the
# physical bridge port defined on vmbr0 so we do not reuse that NIC elsewhere.
- name: Fetch vmbr0 configuration when protected interface looks virtual
  become: true
  command: pvesh get /nodes/localhost/network/vmbr0 --output-format json
  register: vmbr0_config
  changed_when: false
  when: protected_mgmt_iface is defined and (protected_mgmt_iface | regex_search('^fw'))
  check_mode: no

- name: Override protected management interface with vmbr0 bridge port
  set_fact:
    protected_mgmt_iface: "{{ (vmbr0_config.stdout | from_json).bridge_ports.split()[0] }}"
  when:
    - vmbr0_config is defined
    - vmbr0_config.stdout is defined
    - vmbr0_config.stdout | length > 0
    - (vmbr0_config.stdout | from_json).bridge_ports is defined
    - (vmbr0_config.stdout | from_json).bridge_ports | trim != ''

# MAC detection removed - enslavement detection is sufficient

- name: Remove protected management interface from interfaces list
  set_fact:
    interfaces: "{{ interfaces | difference([protected_mgmt_iface]) }}"
  when: protected_mgmt_iface is defined and protected_mgmt_iface != ''

# Get supported link modes for each interface (used for naming logic)
- name: Gather Supported link modes for each interface
  shell: |
    ethtool "{{ item }}" | grep 'Supported link modes:' || echo "Supported link modes: Not reported"
  loop: "{{ all_interfaces }}"
  register: link_modes
  changed_when: false
  check_mode: no

# Build a map interface -> ethtool output for robust lookup
- name: Build link_modes_map (interface -> ethtool stdout)
  set_fact:
    link_modes_map: "{{ dict( all_interfaces | zip(link_modes.results | map(attribute='stdout') | list) ) }}"

# Gather MAC addresses for interfaces
- name: Gather MAC addresses for interfaces
  shell: cat /sys/class/net/{{ item }}/address
  loop: "{{ all_interfaces }}"
  register: mac_results
  changed_when: false
  failed_when: false
  check_mode: no

# Build macs map (interface -> MAC address)
- name: Build macs map
  set_fact:
    macs: "{{ dict(all_interfaces | zip(mac_results.results | map(attribute='stdout') | list)) }}"