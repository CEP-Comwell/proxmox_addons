# Generated by Ansible: linux bridge configuration for {{ (bridge.name if bridge is defined else (item.name if item is defined else 'unknown')) }}
# DO NOT EDIT MANUALLY (unless you know what you're doing)

{#
    Ensure templates work whether the controller passes `bridge` or the task
    uses the loop `item` variable. Older flows used `bridge`, newer tasks use
    `item` â€” tolerate both by preferring `bridge` and falling back to `item`.
#}
{% set bridge = bridge if bridge is defined else (item if item is defined else {}) %}

auto {{ bridge.name }}
iface {{ bridge.name }} inet manual
{% if bridge.ports and bridge.ports | length > 0 %}    bridge_ports {{ bridge.ports | join(' ') }}
{% endif %}    bridge_stp off
    bridge_fd 0
{% if bridge.mtu is defined %}    mtu {{ bridge.mtu }}
{% endif %}

# Subinterfaces
{% for sub in bridge.subinterfaces | default([]) %}
auto {{ sub.name }}
iface {{ sub.name }} inet {{ (sub.options.address is defined) | ternary('static','manual') }}
{% if sub.options.address is defined %}    address {{ sub.options.address }}
{% endif %}{% if sub.options.tag is defined %}    vlan-id {{ sub.options.tag }}
{% elif sub.vlan_id is defined %}    vlan-id {{ sub.vlan_id }}
{% endif %}
{# Emit vlan-raw-device only when a VLAN id or an explicit raw-device is present. #}
{% set _opts = sub.options | default({}) %}
{% set _vlan_id = (_opts.get('tag') if _opts.get('tag') is defined else (_opts.get('vlan-id') if _opts.get('vlan-id') is defined else (sub.vlan_id if sub.vlan_id is defined else None))) %}
{# Prefer an explicit vlan-raw-device/raw-device option, then sub.parent_bridge, then bridge.name #}
{% set _raw_dev = (_opts.get('vlan-raw-device') if _opts.get('vlan-raw-device') is defined else (_opts.get('raw-device') if _opts.get('raw-device') is defined else (sub.parent_bridge if sub.parent_bridge is defined else None))) %}
{# Only emit vlan-raw-device when we actually have a non-empty raw device value. #}
{% if _raw_dev is not none and (_raw_dev|string).strip() != '' %}
    vlan-raw-device {{ _raw_dev }}
{% endif %}
{% if sub.options.mtu is defined %}    mtu {{ sub.options.mtu }}
{% endif %}
{% endfor %}
