# Phase 3: Fabric Finalization - Validate EVPN objects and optionally add missing fabric nodes

- name: Collect desired fabric node definitions
  ansible.builtin.set_fact:
    establish_fabric_desired_nodes: "{{ sdn_fabric_nodes | default([]) }}"

- name: Gather existing fabric nodes from Proxmox
  ansible.builtin.command: >-
    pvesh get /cluster/sdn/fabrics/node/{{ sdn_fabric_name | default('fab-core') }} --output-format json
  register: establish_fabric_existing_nodes_raw
  failed_when: false
  changed_when: false

- name: Parse current fabric node list
  ansible.builtin.set_fact:
    establish_fabric_existing_nodes: >-
      {{ (establish_fabric_existing_nodes_raw.stdout | default('')) | trim | length
         | ternary(establish_fabric_existing_nodes_raw.stdout | from_yaml, []) }}

- name: Capture existing fabric node IDs
  ansible.builtin.set_fact:
    establish_fabric_existing_node_ids: "{{ establish_fabric_existing_nodes | map(attribute='node_id') | list }}"

- name: Determine missing fabric nodes
  ansible.builtin.set_fact:
    establish_fabric_missing_nodes: >-
      {{ establish_fabric_desired_nodes
         | selectattr('node_id', 'defined')
         | selectattr('node_id', 'ne', None)
         | selectattr('node_id', 'ne', '')
         | rejectattr('node_id', 'in', establish_fabric_existing_node_ids | default([]))
         | list }}

- name: Summarise fabric node state
  ansible.builtin.debug:
    msg: |
      Fabric '{{ sdn_fabric_name | default('fab-core') }}' current nodes: {{ establish_fabric_existing_nodes | map(attribute='node_id') | list }}
      Desired nodes: {{ establish_fabric_desired_nodes | map(attribute='node_id') | list }}
      Missing nodes: {{ establish_fabric_missing_nodes | map(attribute='node_id') | list }}

- name: Abort when fabric nodes are missing and auto-create is disabled
  ansible.builtin.fail:
    msg: >-
      Fabric nodes {{ establish_fabric_missing_nodes | map(attribute='node_id') | list }} are not present in fabric '{{ sdn_fabric_name | default('fab-core') }}'.
      Set 'sdn_fabric_node_autocreate=true' or create them manually.
  when:
    - establish_fabric_missing_nodes | length > 0
    - not (sdn_fabric_node_autocreate | default(false))

- name: Create missing fabric nodes (Proxmox VE 9 lacks update handlers)
  ansible.builtin.command: >-
    pvesh create /cluster/sdn/fabrics/node/{{ sdn_fabric_name | default('fab-core') }}
      --node_id {{ item.node_id }}
      --protocol {{ item.protocol | default('openfabric') }}
      {% if item.ip is defined %}--ip {{ item.ip }}{% endif %}
      {% if item.ip6 is defined %} --ip6 {{ item.ip6 }}{% endif %}
  loop: "{{ establish_fabric_missing_nodes }}"
  loop_control:
    label: "{{ item.node_id }}"
  when:
    - establish_fabric_missing_nodes | length > 0
    - sdn_fabric_node_autocreate | default(false)
  register: establish_fabric_create_results

- name: Display results of node creation
  ansible.builtin.debug:
    var: establish_fabric_create_results.results
  when:
    - establish_fabric_create_results is defined

- name: Show SDN zone summary
  ansible.builtin.command: >-
    pvesh get /cluster/sdn/zones/{{ sdn_zone_name | default('zone1') }}
  register: establish_fabric_zone_info
  failed_when: false
  changed_when: false

- name: Display zone summary
  ansible.builtin.debug:
    msg: |
      SDN zone '{{ sdn_zone_name | default('zone1') }}' details:
      {{ establish_fabric_zone_info.stdout | default('Zone not found') }}

- name: Show VNET catalogue
  ansible.builtin.command: >-
    pvesh get /cluster/sdn/vnets --output-format json
  register: establish_fabric_vnets
  failed_when: false
  changed_when: false

- name: Display managed VNets
  ansible.builtin.debug:
    msg: |
      VNET objects present in cluster:
      {{ establish_fabric_vnets.stdout | default('No VNET definitions detected') }}

- name: Show bridge inventory on node
  ansible.builtin.command: ip -br link show type bridge
  register: establish_fabric_bridge_status
  changed_when: false

- name: Display bridge inventory
  ansible.builtin.debug:
    msg: |
      Bridges on {{ inventory_hostname }}:
      {{ establish_fabric_bridge_status.stdout }}

- name: Optionally show BGP status when FRR is present
  ansible.builtin.command: vtysh -c "show bgp summary"
  register: establish_fabric_bgp_status
  changed_when: false
  failed_when: false
  when: "'frr' in group_names or 'bgp' in group_names"

- name: Display BGP status (if collected)
  ansible.builtin.debug:
    msg: |
      BGP status on {{ inventory_hostname }}:
      {{ establish_fabric_bgp_status.stdout | default('FRR/BGP not configured or command unavailable') }}
  when: establish_fabric_bgp_status is defined
