---
# Tasks: Deploy VXLAN overlays for all tenants on a Proxmox node
# This tasks file is imported by the vxlan role main tasks.
    - name: Map default overlay variables (backwards compatibility)
      set_fact:
        tenants: "{{ tenant_overlays | default([]) }}"
        common_services: "{{ service_overlays | default([]) }}"
        vxlan_bridges: "{{ vxlan_bridges | default([]) }}"

    - name: Create bridges
      ansible.builtin.command:
        cmd: "pvesh create /nodes/{{ inventory_hostname }}/network -iface {{ item.name }} -type bridge"
      loop: "{{ vxlan_bridges | default([]) }}"
      when: item.name is defined
      ignore_errors: true
      register: bridge_create_results

    - name: Debug bridge create results
      debug:
        var: bridge_create_results
      when: vxlan_bridges | default([]) | length > 0

    - name: Configure VXLAN overlays per tenant
      ansible.builtin.debug:
        msg: "Configuring overlays for tenant {{ tenant.name }}: {{ tenant.overlays }}"
      loop: "{{ tenants }}"
      loop_control:
        loop_var: tenant

    - name: Create VXLAN interfaces for overlays (idempotent)
      include_tasks: "{{ 'create_vxlan.yml' if (sdn_available | default(false)) else 'create_vxlan_ovs.yml' }}"
      loop: "{{ tenants | map(attribute='overlays') | list | flatten(1) }}"
      loop_control:
        loop_var: overlay
      ignore_errors: true

    - name: Configure common service overlays (e.g., DNS) - idempotent
      include_tasks: "{{ 'create_vxlan.yml' if (sdn_available | default(false)) else 'create_vxlan_ovs.yml' }}"
      loop: "{{ common_services | default([]) }}"
      loop_control:
        loop_var: overlay
      ignore_errors: true

    - name: Configure legacy overlays (e.g., Ceph) - idempotent
      include_tasks: "{{ 'create_vxlan.yml' if (sdn_available | default(false)) else 'create_vxlan_ovs.yml' }}"
      loop: "{{ legacy_overlays | default([]) }}"
      loop_control:
        loop_var: overlay
      ignore_errors: true
