# NFTables Rules for vmbr2 (Gateway Bridge)
# Generated by Ansible - DO NOT EDIT MANUALLY

# Bridge filtering for vmbr2
table bridge vmbr2_filter {
    chain input {
        type filter hook input priority -200;

        {% for rule in nftables_bridge_rules.ingress %}
        {{ rule }}
        {% endfor %}
    }

    chain forward {
        type filter hook forward priority -200;

        {% for rule in nftables_bridge_rules.egress %}
        {{ rule }}
        {% endfor %}

        # Default drop
        drop;
    }
}

# IP filtering for vmbr2 traffic
table ip vmbr2_ip {
    chain input {
        type filter hook input priority -200;

        # Gateway network traffic rules
        iif "vmbr2" tcp dport { 80, 443, 3128 } accept;  # HTTP, HTTPS, Squid proxy
        iif "vmbr2" udp dport { 53, 123 } accept;        # DNS, NTP
        iif "vmbr2" icmp type { echo-request, echo-reply } accept;
    }

    chain forward {
        type filter hook forward priority -200;

        # Allow gateway traffic forwarding to management only
        iif "vmbr2" oif "vmbr99" accept;  # To management
        iif "vmbr99" oif "vmbr2" accept;  # Return traffic

        # Allow NAT/masquerade if configured
        ct state established,related accept;
    }
}