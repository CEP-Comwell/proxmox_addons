# Default variables for nftables role
# You can expand this for per-zone/group rules later
nftables_default_policy: "drop"
nftables_allow_icmp: true
nftables_allow_management_to_all: true
# Placeholder for future dynamic rules
nftables_explicit_rules: []

# NAT configuration
nftables_nat_enabled: false
nftables_nat_external_iface: ""
nftables_nat_source_networks: []
nftables_nat_postrouting_rules: []

# Bridge Access Control Variables
nftables_configure_bridges: false
nftables_bridge_rules_dir: "/etc/nftables.d"

# Bridge configurations (when nftables_configure_bridges is true)
nftables_bridges:
  - name: vmbr99
    description: "Management Bridge"
  - name: vmbr1
    description: "Tenant Bridge"
  - name: vmbr2
    description: "Gateway Bridge"

# Bridge Access Control Policies
nftables_bridge_access_control:
  vmbr99:
    ingress_policy: "allow_from_all_responses"
    egress_policy: "allow_to_all"
    allowed_peers: ["vmbr1", "vmbr2"]
    blocked_peers: []

  vmbr1:
    ingress_policy: "management_only"
    egress_policy: "management_only"
    allowed_peers: ["vmbr99"]
    blocked_peers: ["vmbr2"]

  vmbr2:
    ingress_policy: "management_only"
    egress_policy: "management_only"
    allowed_peers: ["vmbr99"]
    blocked_peers: ["vmbr1"]

# Detailed Rule Sets for each bridge
nftables_bridge_rules:
  vmbr99:
    ingress:
      - "iif \"vmbr99\" arp accept"
      - "iif \"vmbr99\" udp dport 67 udp sport 68 accept"
      - "iif \"vmbr99\" ct state established,related accept"
      - "iif \"vmbr99\" icmp type echo-reply accept"
      - "iif \"vmbr99\" ct state invalid drop"
    egress:
      - "iif \"vmbr99\" oif \"vmbr1\" accept"
      - "iif \"vmbr99\" oif \"vmbr2\" accept"
      - "ct state established,related accept"

  vmbr1:
    ingress:
      - "iif \"vmbr1\" iif != \"vmbr99\" drop"
      - "iif \"vmbr1\" arp accept"
      - "iif \"vmbr1\" udp dport 67 udp sport 68 accept"
      - "iif \"vmbr1\" icmp type echo-request accept"
      - "iif \"vmbr1\" ct state established,related accept"
    egress:
      - "iif \"vmbr1\" oif \"vmbr99\" accept"
      - "iif \"vmbr1\" oif \"vmbr2\" drop"
      - "iif \"vmbr1\" oif \"vmbr99\" icmp type echo-reply accept"

  vmbr2:
    ingress:
      - "iif \"vmbr2\" iif != \"vmbr99\" drop"
      - "iif \"vmbr2\" arp accept"
      - "iif \"vmbr2\" udp dport 67 udp sport 68 accept"
      - "iif \"vmbr2\" icmp type echo-request accept"
      - "iif \"vmbr2\" ct state established,related accept"
    egress:
      - "iif \"vmbr2\" oif \"vmbr99\" accept"
      - "iif \"vmbr2\" oif \"vmbr1\" drop"
      - "iif \"vmbr2\" oif \"vmbr99\" icmp type echo-reply accept"
