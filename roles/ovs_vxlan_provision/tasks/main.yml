---
# Idempotent creation of OVS VXLAN ports using ovs-vsctl
# This task file is intentionally conservative: it only runs when
# the global `ovs_create` is true and the chosen method is `ovs-vsctl`.

- name: "Load host-specific ovs vxlan ports vars (optional)"
  include_vars:
    file: "{{ playbook_dir }}/../../host_vars/{{ inventory_hostname }}/ovs_vxlan_ports.yml"
    name: host_ovs_vxlan
  ignore_errors: true

- name: "Load host bridge definitions (optional)"
  include_vars:
    file: "{{ playbook_dir }}/../../host_vars/{{ inventory_hostname }}/bridges.yml"
    name: host_bridges
  ignore_errors: true

- name: "Discover existing OVS bridge names on the host"
  command: ovs-vsctl --bare --no-heading list-br
  register: ovs_br_names
  failed_when: false
  changed_when: false

- name: "Set effective_ovs_bridges from runtime OVS list"
  set_fact:
    effective_ovs_bridges: "{{ ovs_br_names.stdout_lines | default([]) }}"

- name: "Collect OVS bridge names from role/host vars (if present)"
  set_fact:
    effective_ovs_bridges: "{{ effective_ovs_bridges + [ item.name ] }}"
  loop: "{{ host_bridges.bridges | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  when: (item.name is defined) and (item.type is defined) and ('ovs' in (item.type | lower))

  # Build effective vxlan ports list
  # Build filtered list by iterating and appending only ports whose parent bridge
  # is in the computed list of OVS bridges. Using a loop avoids unsupported
  # lambda expressions in some Jinja/Ansible combinations.
- name: "Initialize tmp vxlan ports list"
  set_fact:
    tmp_ovs_vxlan_ports: []

- name: "Collect vxlan ports that target OVS bridges"
  set_fact:
    tmp_ovs_vxlan_ports: "{{ tmp_ovs_vxlan_ports + [ item ] }}"
  loop: "{{ (host_ovs_vxlan.ovs_vxlan_ports | default([])) + (ovs_vxlan_ports | default([])) }}"
  when: (item.bridge is defined) and (item.bridge in (effective_ovs_bridges | default([])))

- name: "Set effective vxlan ports list from tmp"
  set_fact:
    effective_ovs_vxlan_ports: "{{ tmp_ovs_vxlan_ports }}"

- name: "Skip OVS VXLAN provisioning when no ports defined"
  debug:
    msg: "No ovs_vxlan_ports defined; skipping OVS vxlan creation"
  when: (effective_ovs_vxlan_ports | length) == 0

- name: "Ensure each VXLAN port exists (ovs-vsctl)"
  when: (ovs_create | default(false)) and (ovs_vxlan_method == 'ovs-vsctl') and (effective_ovs_vxlan_ports | length > 0)
  block:
    - name: "Include per-port tasks for VXLAN creation"
      include_tasks: each_port.yml
      loop: "{{ effective_ovs_vxlan_ports }}"
      loop_control:
        label: "{{ (item.name | default('vx' ~ (item.vni | string))) }}@{{ item.bridge | default('vmbr1') }}"
  rescue:
    - name: "Fail: building OVS vxlan ports encountered an error"
      fail:
        msg: "An error occurred while creating OVS VXLAN ports; check OVS status and the inputs"
