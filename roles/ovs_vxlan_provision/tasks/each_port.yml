---
# Tasks to ensure a single VXLAN port (expects 'item' from loop in caller)
- name: "Set vx and port_name variables for item"
  set_fact:
    vx: "{{ item }}"
    port_name: "{{ item.name | default('vx' ~ (item.vni | string)) }}"

- name: "Validate vxlan port name length for {{ port_name }}"
  assert:
    that:
      - (port_name | length) <= 8
    fail_msg: "VXLAN port name '{{ port_name }}' is longer than 8 characters; shorten to <=8 per project policy."
  when: port_name is defined

- name: "Build external_ids string for OVS interface {{ port_name }}"
  set_fact:
    ovs_external_ids: >-
      {%- set kv = [] -%}
      {%- if vx.vnet is defined -%}{%- set _ = kv.append('vnet="' ~ (vx.vnet | string) ~ '"') -%}{%- endif -%}
      {%- if vx.subnet is defined -%}{%- set _ = kv.append('subnet="' ~ (vx.subnet | string) ~ '"') -%}{%- endif -%}
      {%- if vx.gateway is defined -%}{%- set _ = kv.append('gateway="' ~ (vx.gateway | string) ~ '"') -%}{%- endif -%}
      {%- if vx.dhcp_range is defined -%}{%- set _ = kv.append('dhcp_range="' ~ (vx.dhcp_range | string) ~ '"') -%}{%- endif -%}
      {%- if vx.dns_zone is defined -%}{%- set _ = kv.append('dns_zone="' ~ (vx.dns_zone | string) ~ '"') -%}{%- endif -%}
      {%- if vx.human_name is defined -%}{%- set _ = kv.append('human_name="' ~ (vx.human_name | string) ~ '"') -%}{%- endif -%}
      {%- if vx.features is defined -%}{%- set _ = kv.append('features="' ~ (vx.features | join('; ') | string) ~ '"') -%}{%- endif -%}
      {{ kv | join(',') }}
  when: vx is defined

- name: "Check if OVS interface {{ port_name }} exists"
  command: "ovs-vsctl --timeout=10 --bare --no-heading --columns=name list Interface {{ port_name }}"
  register: ovs_iface_check
  failed_when: false
  changed_when: false

- name: "Wait for bridge {{ vx.bridge }} to exist before creating {{ port_name }}"
  command: "ovs-vsctl --timeout=10 br-exists {{ vx.bridge }}"
  register: br_exists
  failed_when: false
  changed_when: false
  until: br_exists.rc == 0
  retries: 6
  delay: 2
  when: (not ansible_check_mode) and (vx.bridge is defined)
 
- name: "Derive local_ip for {{ port_name }} from host_bridges (fallback to ansible_default_ipv4)"
  set_fact:
    local_ip: >-
      {{ ((host_bridges.bridges | default([]) | selectattr('name','equalto', vx.bridge) | map(attribute='address') | list | first | default('')) | regex_replace('/.*$','')) | default(ansible_default_ipv4.address) }}
  when: not ansible_check_mode

- name: "Derive remote_ip for kernel vxlan when requested for {{ port_name }}"
  set_fact:
    remote_ip: "{{ vx.remote_ip | default(ovs_vxlan_static_remote_ip | default('')) }}"
  when: (kernel_vxlan_only | default(false)) and not ansible_check_mode

- name: "Create OVS port {{ port_name }} on bridge {{ vx.bridge }}"
  command: >-
    ovs-vsctl --may-exist add-port {{ vx.bridge }} {{ port_name }} -- \
      set interface {{ port_name }} type=vxlan \
      options:key="flow" options:remote_ip="{{ vx.remote_ip | default(ovs_vxlan_static_remote_ip | default('flow')) }}" options:local_ip="{{ local_ip }}" options:nolearning=true options:csum=true {% if vx.dst_port is defined %}options:dst_port="{{ vx.dst_port }}"{% endif %}
  register: ovs_add_result
  become: true
  when: (ovs_iface_check.stdout | default('') == '') and (not ansible_check_mode) and not (kernel_vxlan_only | default(false))
  changed_when: ovs_add_result.rc == 0
  failed_when: ovs_add_result.rc != 0

- name: "Ensure existing OVS interface {{ port_name }} is configured for flow-mode"
  command: >-
    ovs-vsctl set Interface {{ port_name }} \
      options:key="flow" options:remote_ip="{{ vx.remote_ip | default(ovs_vxlan_static_remote_ip | default('flow')) }}" options:local_ip="{{ local_ip }}" options:nolearning=true options:csum=true {% if vx.dst_port is defined %}options:dst_port="{{ vx.dst_port }}"{% endif %}
  register: ovs_update_opts
  become: true
  when: (ovs_iface_check.stdout | default('') != '') and (not ansible_check_mode) and not (kernel_vxlan_only | default(false))
  changed_when: ovs_update_opts.rc == 0

- name: "Annotate OVS interface {{ port_name }} with external_ids metadata"
  command: >-
    ovs-vsctl set Interface {{ port_name }} {% if ovs_external_ids|default('') != '' %}external_ids:{{ ovs_external_ids }}{% else %}external_ids:managed_by=ansible{% endif %}
  register: ovs_set_extids
  become: true
  failed_when: false
  changed_when: false
  when: not ansible_check_mode

- name: "Ensure MTU for {{ port_name }} is set"
  become: true
  block:
    - name: "Set link MTU on {{ port_name }}"
      command: "ip link set {{ port_name }} mtu {{ vx.mtu | default(9000) }}"
      failed_when: false
      changed_when: false

    - name: "Request OVS port MTU via ovs-vsctl for {{ port_name }}"
      command: "ovs-vsctl set Interface {{ port_name }} mtu_request={{ vx.mtu | default(9000) }}"
      failed_when: false
      changed_when: false
  when: not ansible_check_mode

# Kernel-based VXLAN creation and attach as a system netdev (when requested)
- name: "Kernel VXLAN create and attach for {{ port_name }} when kernel_vxlan_only"
  block:
    - name: "Validate remote_ip provided for kernel VXLAN {{ port_name }}"
      assert:
        that:
          - remote_ip != ''
        fail_msg: "kernel_vxlan_only is true but no remote_ip (vx.remote_ip or ovs_vxlan_static_remote_ip) provided for {{ port_name }}"

    - name: "Create kernel vxlan device {{ port_name }}"
      become: true
      shell: >-
        ip link add {{ port_name }} type vxlan id {{ vx.vni }} local {{ local_ip }} remote {{ remote_ip }} dstport {{ vx.dst_port | default(4789) }} || true

    - name: "Bring up kernel device {{ port_name }}"
      become: true
      command: ip link set {{ port_name }} up

    - name: "Set MTU on kernel device {{ port_name }}"
      become: true
      command: ip link set {{ port_name }} mtu {{ vx.mtu | default(9000) }}

    - name: "Add kernel device {{ port_name }} to OVS bridge {{ vx.bridge }}"
      become: true
      command: ovs-vsctl --may-exist add-port {{ vx.bridge }} {{ port_name }}

    - name: "Detect misconfigured OVS Interface that requires re-add for {{ port_name }}"
      become: true
      command: ovs-vsctl --columns=type,options --bare --no-heading list Interface {{ port_name }}
      register: iface_row
      failed_when: false
      changed_when: false

    - name: "If Interface {{ port_name }} is type=vxlan without remote_ip, delete and re-add port"
      become: true
      block:
        - name: "Delete existing port {{ port_name }} from bridge {{ vx.bridge }}"
          command: ovs-vsctl --if-exists del-port {{ vx.bridge }} {{ port_name }}

        - name: "Re-add kernel device {{ port_name }} to OVS bridge {{ vx.bridge }}"
          command: ovs-vsctl --may-exist add-port {{ vx.bridge }} {{ port_name }}

      when: "iface_row.stdout is defined and ('vxlan' in iface_row.stdout) and ('remote' not in iface_row.stdout)"

    - name: "Annotate kernel-backed OVS interface {{ port_name }} with external_ids metadata"
      become: true
      command: >-
        ovs-vsctl set Interface {{ port_name }} {% if ovs_external_ids|default('') != '' %}external_ids:{{ ovs_external_ids }}{% else %}external_ids:managed_by=ansible{% endif %}
      failed_when: false
      changed_when: false

    - name: "Request OVS port MTU via ovs-vsctl for kernel-backed {{ port_name }}"
      become: true
      command: "ovs-vsctl set Interface {{ port_name }} mtu_request={{ vx.mtu | default(9000) }}"
      failed_when: false
      changed_when: false

    - name: "Get ofport for kernel-backed {{ port_name }} (wait until >0)"
      command: "ovs-vsctl --bare --no-heading get Interface {{ port_name }} ofport"
      register: ovs_ofport_kernel
      failed_when: false
      changed_when: false
      retries: 6
      delay: 2
      until: (ovs_ofport_kernel.stdout | default('0') | int) > 0
  when: (kernel_vxlan_only | default(false)) and (not ansible_check_mode)

- name: "Fail if kernel-backed ofport invalid for {{ port_name }}"
  fail:
    msg: "Kernel VXLAN {{ port_name }} has invalid ofport={{ ovs_ofport_kernel.stdout | default('') }}; expected > 0"
  when: ((ovs_ofport_kernel.stdout | default('0') | int) <= 0) and (kernel_vxlan_only | default(false)) and (not ansible_check_mode)

- name: "Debug: show interface details for {{ port_name }}"
  command: "ovs-vsctl --columns=name,type,options list Interface {{ port_name }}"
  register: ovs_iface_show
  changed_when: false

- name: "Debug: show result"
  debug:
    msg:
      - "port={{ port_name }} check.stdout={{ ovs_iface_check.stdout }}"
      - "add_result={{ ovs_add_result.stdout | default('n/a') }}"
      - "iface_show={{ ovs_iface_show.stdout | default('n/a') }}"

- name: "Verify VXLAN interface {{ port_name }} exists and is type vxlan"
  become: true
  command: "ovs-vsctl --timeout=5 --bare --no-heading --columns=type list Interface {{ port_name }}"
  register: verify_iface
  failed_when: false
  changed_when: false

- name: "Fail if VXLAN {{ port_name }} not present or not type vxlan"
  fail:
    msg: "VXLAN {{ port_name }} missing or not of type 'vxlan' after creation: {{ verify_iface.stdout | default('') }}"
  when: (verify_iface.rc != 0) or ((not (kernel_vxlan_only | default(false))) and ('vxlan' not in (verify_iface.stdout | default(''))))

- name: "Get ofport for {{ port_name }} (wait until >0)"
  command: "ovs-vsctl --bare --no-heading get Interface {{ port_name }} ofport"
  register: ovs_ofport
  failed_when: false
  changed_when: false
  retries: 6
  delay: 2
  until: (ovs_ofport.stdout | default('0') | int) > 0
  when: not ansible_check_mode


- name: "Attempt kernel vxlan device creation for {{ port_name }} when ofport invalid"
  block:
    - name: "Create kernel vxlan device {{ port_name }}"
      become: true
      shell: >-
        ip link add {{ port_name }} type vxlan id {{ vx.vni }} local {{ local_ip }} dstport {{ vx.dst_port | default(4789) }} || true

    - name: "Bring up kernel device {{ port_name }}"
      become: true
      command: ip link set {{ port_name }} up

    - name: "Reattach or add port {{ port_name }} to OVS bridge {{ vx.bridge }}"
      become: true
      command: ovs-vsctl --may-exist add-port {{ vx.bridge }} {{ port_name }}

    - name: "Re-check ofport for {{ port_name }} (wait until >0)"
      command: "ovs-vsctl --bare --no-heading get Interface {{ port_name }} ofport"
      register: ovs_ofport_retry
      failed_when: false
      changed_when: false
      retries: 6
      delay: 2
      until: (ovs_ofport_retry.stdout | default('0') | int) > 0
  when: (ovs_ofport.stdout | default('0') | int) <= 0 and (not ansible_check_mode)

- name: "Fail if ofport invalid for {{ port_name }}"
  fail:
    msg: "VXLAN {{ port_name }} has invalid ofport={{ (ovs_ofport_retry.stdout if (ovs_ofport_retry is defined) else ovs_ofport.stdout) | default('') }}; expected > 0"
  when: ((ovs_ofport_retry.stdout | default(ovs_ofport.stdout | default('0')) | int) <= 0) and (not ansible_check_mode)
