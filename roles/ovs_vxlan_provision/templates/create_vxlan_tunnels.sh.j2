#!/bin/sh
# Auto-generated by Ansible: creates kernel VXLAN devices and attaches to OVS
# Idempotent: will create missing links and attempt an automatic repair if OVS
# shows an Interface row with no datapath binding (ofport <= 0).

set -eu

# retry loop helper: try up to N times to repair an OVS binding
repair_binding() {
  BRIDGE="$1"
  PORT="$2"
  tries=0
  max_tries=5
  while [ $tries -lt $max_tries ]; do
    tries=$((tries + 1))
    echo "Repair attempt ${tries}/${max_tries} for ${PORT} on ${BRIDGE}"
    ovs-vsctl --if-exists del-port "${BRIDGE}" "${PORT}" || true
    sleep 1
    ovs-vsctl --may-exist add-port "${BRIDGE}" "${PORT}" || true
    sleep 1
    ofport=$(ovs-vsctl --bare --no-heading get Interface "${PORT}" ofport 2>/dev/null || echo "")
    case "${ofport}" in
      ''|0|-* )
        echo "still no valid ofport for ${PORT} (got: '${ofport}'), continuing"
        ;;
      *)
        echo "binding repaired: ${PORT} -> ofport ${ofport}"
        return 0
        ;;
    esac
  done
  echo "failed to repair ${PORT} after ${max_tries} attempts"
  return 1
}

{% for vx in effective_ovs_vxlan_ports %}
{% set port_name = (vx.name | default('vx' ~ (vx.vni | string))) %}
{% set bridge = vx.bridge %}
{% set vni = vx.vni %}
{% set dstport = vx.dst_port | default(4789) %}
{% set mtu = vx.mtu | default(9000) %}
{% set local_ip = ((host_bridges.bridges | default([]) | selectattr('name','equalto', vx.bridge) | map(attribute='address') | list | first | default('')) | regex_replace('/.*$','')) | default(ansible_default_ipv4.address) %}
{% set remote_ip = (vx.remote_ip | default(ovs_vxlan_static_remote_ip | default(''))) %}

PORT="{{ port_name }}"
BRIDGE="{{ bridge }}"
VNI="{{ vni }}"

if ip link show "${PORT}" >/dev/null 2>&1; then
  echo "${PORT} already exists as kernel netdev"
else
  echo "Creating kernel vxlan ${PORT} (vni=${VNI})"
  if [ -n "{{ remote_ip }}" ]; then
    ip link add "${PORT}" type vxlan id ${VNI} local {{ local_ip }} remote {{ remote_ip }} dstport {{ dstport }} || true
  else
    ip link add "${PORT}" type vxlan id ${VNI} local {{ local_ip }} dstport {{ dstport }} || true
  fi
  ip link set "${PORT}" up || true
  ip link set "${PORT}" mtu {{ mtu }} || true
fi

# Ensure OVS has the port and that it is bound to a datapath (ofport > 0)
ovs-vsctl --may-exist add-port "${BRIDGE}" "${PORT}" || true
ofport=$(ovs-vsctl --bare --no-heading get Interface "${PORT}" ofport 2>/dev/null || echo "")
case "${ofport}" in
  ''|0|-* )
    echo "${PORT} has no valid ofport (got: '${ofport}'), attempting repair"
    repair_binding "${BRIDGE}" "${PORT}" || true
    ;;
  *)
    echo "${PORT} bound to ofport ${ofport}"
    ;;
esac

{% endfor %}

exit 0
