---
# Persist IPv4 gateway addresses on OVS bridges used for VXLAN testing.
# This playbook writes an interfaces fragment to /etc/network/interfaces.d
# and (optionally) runs a network reload. Defaults are conservative: no reload.

- hosts: "{{ target | default('pve1.comwell.edgesec.ca') }}"
  become: yes
  gather_facts: no

  vars:
    # mapping bridge -> cidr
    vmbr_ips:
      vmbr1: "10.101.1.1/24"
      vmbr99: "10.102.1.1/24"
    output_path: "/etc/network/interfaces.d/edgesec-vxlan-gateways.cfg"
    # set to true if you want the playbook to run `ifreload -a` after writing
    # the file. Default false to avoid accidental reloads.
    do_reload: false

  tasks:
    - name: Build interfaces fragment content
      set_fact:
        iface_fragment: |
          # ANSIBLE managed: vxlan bridge gateway fragment
          # Generated by playbooks/persist_bridge_ips.yml
          {% for br, cidr in vmbr_ips.items() %}
          auto {{ br }}
          iface {{ br }} inet static
              address {{ cidr }}

          {% endfor %}

    - name: Ensure interfaces.d directory exists
      file:
        path: /etc/network/interfaces.d
        state: directory
        mode: '0755'

    - name: Write bridge gateway fragment (backup if exists)
      copy:
        content: "{{ iface_fragment }}"
        dest: "{{ output_path }}"
        owner: root
        group: root
        mode: '0644'
        backup: yes

    - name: Show created fragment (for review)
      command: cat {{ output_path }}
      register: frag
      changed_when: false

    - name: Debug fragment
      debug:
        msg: "Created {{ output_path }}:\n{{ frag.stdout }}"

    - name: Optionally reload networking (disabled by default)
      when: do_reload | bool
      block:
        - name: Try guarded reload script if present
          shell: |
            if [ -x /usr/local/bin/guarded_ifreload.sh ]; then
              /usr/local/bin/guarded_ifreload.sh
            elif [ -x /opt/guarded_ifreload.sh ]; then
              /opt/guarded_ifreload.sh
            else
              ifreload -a
            fi
          register: reload_out

        - name: Show reload result
          debug:
            var: reload_out

    - name: Ensure host_vars directory exists on controller for this host
      delegate_to: localhost
      become: false
      local_action:
        module: file
        path: "./host_vars/{{ inventory_hostname }}"
        state: directory
        mode: '0755'

    - name: Write inventory host var file (persist vmbr gateway mapping) on controller
      delegate_to: localhost
      become: false
      local_action:
        module: copy
        content: "{{ {'vmbr_gateway_ips': vmbr_ips} | to_nice_yaml }}"
        dest: "./host_vars/{{ inventory_hostname }}/vxlan_gateways.yml"
        mode: '0644'
      run_once: false
